name: Run e2e tests on Kedro-Viz
# Runs end-to-end tests on Kedro-Viz for different 
# operating systems and Python versions.

on:
  workflow_call:
    inputs:
      os:
        type: string
      python-version:
        type: string
    secrets:
      GH_E2E_AUTH_TOKEN:
        required: false
      GH_TAGGING_TOKEN:
        required: false
jobs:
    e2e_tests:
        runs-on: ${{ inputs.os }}

        # below condition checks if the operating system is Ubuntu, or 
        # if the operating system is Windows and the branch is main/demo
        if: >
          inputs.os == 'ubuntu-latest' || 
          (
            (
              github.ref == 'refs/heads/main' || 
              github.ref == 'refs/heads/demo'
            ) && 
            inputs.os == 'windows-latest'
          )
          
        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Debug secrets existence
          run: |
            echo "GH_TAGGING_TOKEN is ${#GH_TAGGING_TOKEN} characters long"
            echo "GH_E2E_AUTH_TOKEN is ${#GH_E2E_AUTH_TOKEN} characters long"
          env:
            GH_TAGGING_TOKEN: ${{ secrets.GH_TAGGING_TOKEN }}
            GH_E2E_AUTH_TOKEN: ${{ secrets.GH_E2E_AUTH_TOKEN }}

        - name: Token Debug
          env:
            GH_TAGGING_TOKEN: ${{ secrets.GH_TAGGING_TOKEN }}
          run: |
            echo "üîê Token length check: ${#GH_TAGGING_TOKEN}"

        - name: Clone latest kedro-starters release into package/starters and echo path
          env:
            GH_E2E_AUTH_TOKEN: ${{ secrets.GH_E2E_AUTH_TOKEN }}
          run: |
            echo "üîê Token length check: ${#GH_E2E_AUTH_TOKEN}"

            API_RESPONSE=$(curl -s -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_E2E_AUTH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/kedro-org/kedro-starters/releases/latest)

            echo "üßæ GitHub API response:"
            echo "$API_RESPONSE"

            LATEST_TAG=$(echo "$API_RESPONSE" | jq -r '.tag_name')

            if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" == "null" ]; then
              echo "‚ùå Failed to get tag"
              exit 1
            fi

            echo "üì¶ Latest tag: $LATEST_TAG"

            mkdir -p package/starters
            git clone --depth 1 --branch "$LATEST_TAG" \
              https://github.com/kedro-org/kedro-starters.git package/starters

            echo "‚úÖ Cloned into: $(pwd)/package/starters"
            echo "üìÇ Contents of package/starters:"
            ls -la package/starters

            echo "üìÇ Contents of package/starters/spaceflights-pandas:"
            ls -la package/starters/spaceflights-pandas || echo "‚ùå spaceflights-pandas folder not found!"


        - name: Setup Tests
          uses: "./.github/actions/setup_tests"
          with:
            os: ${{ inputs.os }}
            python-version: ${{ inputs.python-version }}
            
        - name: Run all end to end tests
          run: make e2e-tests 