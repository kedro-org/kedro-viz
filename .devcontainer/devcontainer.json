// For format details, see https://aka.ms/devcontainer.json. For config options, see the
// README at: https://github.com/devcontainers/templates/tree/main/src/python
{
	"name": "Kedro Viz Dev Container",
	// Or use a Dockerfile or Docker Compose file. More info: https://containers.dev/guide/dockerfile
	"image": "mcr.microsoft.com/devcontainers/python:1-3.11-bullseye",

	// Features to add to the dev container. More info: https://containers.dev/features.
	"features": {
		"ghcr.io/devcontainers/features/node:1": {
			"version": "18",
			"nodeGypDependencies": true
		}
	},

	"forwardPorts": [4141, 4142],

	"portsAttributes": {
		"4142": {
			"label": "Backend",
			"onAutoForward": "notify"
		},
		"4141": {
			"label": "Frontend",
			"onAutoForward": "openBrowser"
		}
	},

	"containerEnv": {
		"DISPLAY": "dummy",
		"PYTHONUNBUFFERED": "True",
		"UV_LINK_MODE": "copy",
		"VIRTUAL_ENV": "/home/vscode/venv"
	},

	// https://code.visualstudio.com/remote/advancedcontainers/improve-performance#_use-a-targeted-named-volume
	"mounts": [
		{"source": "${localWorkspaceFolderBasename}-node_modules", "target": "${containerWorkspaceFolder}/node_modules", "type": "volume"},
		{"source": "${localWorkspaceFolderBasename}-venv", "target": "${containerWorkspaceFolder}/.venv", "type": "volume"}
	],

	"onCreateCommand": "./.devcontainer/onCreateCommand.sh",

	"postStartCommand": {
		"backend": "nohup bash -c 'uv run python package/kedro_viz/server.py demo-project &' > backend.out 2> backend.err < /dev/null",
		"frontend": "nohup bash -c 'BROWSER=none npm run start:app &' > frontend.out 2> frontend.err < /dev/null"
	},

	"customizations": {
		"vscode": {
			"extensions": [
				"ms-python.python"
			]
		}
	}
}
